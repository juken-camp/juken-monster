<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>ğŸ“ JUKEN MONSTER ğŸ“</title>

  <style>
    html, body {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
    }
    
    /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯ */
    .particle {
      position: absolute;
      background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); opacity: 0.5; }
      50% { transform: translateY(-15px); opacity: 0.8; }
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding: 8px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .title {
      font-size: 18px;
      font-weight: 900;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      flex-shrink: 0;
    }

    .title:hover {
      transform: scale(1.05);
      transition: transform 0.2s ease;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .title:active {
      transform: scale(0.95);
    }
    
    .stats {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .stat {
      background: rgba(255,255,255,0.2);
      padding: 3px 8px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .game-container {
      padding: 15px;
      max-width: 420px;
      margin: 0 auto;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 18px;
      margin-bottom: 15px;
      backdrop-filter: blur(10px);
    }
    
    .cell {
      aspect-ratio: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      min-height: 60px;
    }
    
    .cell:hover {
      transform: scale(1.05);
      background: rgba(255,255,255,0.2);
    }
    
    .cell.occupied {
      background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
      border: 2px solid rgba(255,255,255,0.4);
      animation: monsterPulse 2s ease-in-out infinite;
    }
    
    .cell.bonus {
      border: 2px solid #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    .cell.dragging {
      transform: scale(1.1);
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .cell.drop-target {
      border: 3px solid #4ecdc4;
      background: rgba(78, 205, 196, 0.2);
    }
    
    @keyframes monsterPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    .monster {
      font-size: 24px;
      animation: monsterIdle 3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
    }
    
    @keyframes monsterIdle {
      0%, 100% { transform: rotate(-2deg); }
      50% { transform: rotate(2deg); }
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      color: white;
      font-family: inherit;
      white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #a8e6cf, #88d8c0);
      box-shadow: 0 4px 12px rgba(168, 230, 207, 0.4);
    }
    
    .btn-shop {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #333;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .study-btn {
      background: linear-gradient(45deg, #ff6b6b, #ffa500, #ff6b6b);
      background-size: 200% 200%;
      animation: studyShine 2s ease-in-out infinite;
      border: 2px solid #ffd700;
      font-size: 14px; /* å°‘ã—å¤§ãã‚ */
      padding: 12px 20px; /* å°‘ã—å¤§ãã‚ */
      flex-shrink: 0; /* ã“ã®ãƒœã‚¿ãƒ³ã¯ç¸®ã¿ã«ããã™ã‚‹ */
    }
    
    @keyframes studyShine {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.hidden {
      display: none;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 20px; /* å°‘ã—èª¿æ•´ */
      text-align: center;
      max-width: 380px;
      width: 100%;
      color: white;
      animation: modalSlideIn 0.5s ease-out;
      max-height: 90vh; /* å°‘ã—æ‹¡å¤§ */
      overflow-y: auto;
    }
    
    @keyframes modalSlideIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .math-question {
      font-size: 28px; /* å°‘ã—èª¿æ•´ */
      font-weight: bold;
      margin: 15px 0; /* å°‘ã—èª¿æ•´ */
      padding: 15px; /* å°‘ã—èª¿æ•´ */
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      min-height: 45px; /* å°‘ã—èª¿æ•´ */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === è¨ˆç®—å•é¡Œã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ› === */
    .math-answer-display {
        background: rgba(255,255,255,0.9);
        color: #333;
        border-radius: 10px;
        padding: 12px;
        font-size: 24px;
        font-weight: bold;
        min-height: 30px; /* é«˜ã•ã‚’ç¢ºä¿ */
        margin: 15px auto;
        width: 80%;
        max-width: 200px;
        text-align: center;
        letter-spacing: 2px;
        border: 2px solid rgba(255,255,255,0.7);
    }
    .math-numpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 20px 0;
    }
    .math-numpad button {
        padding: 15px; /* ååˆ†ãªã‚¿ãƒƒãƒ—é ˜åŸŸ */
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        background: rgba(255,255,255,0.3);
        color: white;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .math-numpad button:hover {
        background: rgba(255,255,255,0.5);
    }
    .math-numpad button:active {
        background: rgba(255,255,255,0.7);
    }
    .numpad-action { /* Backspace, Clear for example */
        background: rgba(255,107,107,0.5) !important; /* ç›®ç«‹ã¤è‰² */
    }
     .numpad-zero {
        grid-column: span 3; /* 0ãƒœã‚¿ãƒ³ã‚’åºƒãã™ã‚‹ä¾‹ */
    }
    /* === ã“ã“ã¾ã§ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ› === */
    
    .shop-items { /* ... (å¤‰æ›´ãªã—) ... */ }
    .shop-item { /* ... (å¤‰æ›´ãªã—) ... */ }
    /* ... ä»–ã®æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« ... */

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    .controls {
      display: flex;
      gap: 6px; /* å°‘ã—ç¸®å° */
      justify-content: center;
      align-items: center; /* ãƒœã‚¿ãƒ³ã®ç¸¦ä½ç½®ã‚’æƒãˆã‚‹ */
      margin-bottom: 15px;
      flex-wrap: nowrap; /* æŠ˜ã‚Šè¿”ã—ã‚’ç¦æ­¢ */
      width: 100%; /* è¦ªè¦ç´ ã®å¹…ã‚’åŸºæº–ã« */
      overflow-x: auto; /* ä¸‡ãŒä¸€ã¯ã¿å‡ºãŸå ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ï¼ˆåŸºæœ¬çš„ã«ã¯ä¸è¦ãªã¯ãšï¼‰ */
    }
    .controls .btn {
      padding: 8px 12px; /* å…¨ä½“çš„ã«å°‘ã—ç¸®å° */
      font-size: 11px; /* å…¨ä½“çš„ã«å°‘ã—ç¸®å° */
      flex-shrink: 1; /* å¿…è¦ã«å¿œã˜ã¦ç¸®å°è¨±å¯ */
      min-width: 0; /* flex-shrinkã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
    }
    .controls .study-btn {
      padding: 10px 15px; /* å€‹åˆ¥ã«èª¿æ•´ */
      font-size: 12px; /* å€‹åˆ¥ã«èª¿æ•´ */
      flex-shrink: 0; /* ã“ã®ãƒœã‚¿ãƒ³ã¯ç¸®ã¿ã«ããã™ã‚‹ */
    }
     .controls .btn-shop {
        flex-grow: 1; /* ã‚·ãƒ§ãƒƒãƒ—ãƒœã‚¿ãƒ³ã«ä½™ç™½ã‚’å‰²ã‚Šå½“ã¦ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) */
        text-align: center;
    }
    .controls .btn-secondary { /* è‡ªå‹•å­¦ç¿’ãƒœã‚¿ãƒ³ */
        flex-grow: 1; /* è‡ªå‹•å­¦ç¿’ãƒœã‚¿ãƒ³ã«ã‚‚ä½™ç™½ã‚’å‰²ã‚Šå½“ã¦ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) */
        text-align: center;
    }


    .effects-container { /* ... (å¤‰æ›´ãªã—) ... */ }
    .merge-effect { /* ... (å¤‰æ›´ãªã—) ... */ }
    /* ... (ä»¥ä¸‹ã€ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã»ã¼å¤‰æ›´ãªã—ã€å¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´) ... */
    
    /* ã‚¹ãƒãƒ›å¯¾å¿œ */
    @media (max-width: 480px) {
      .header { padding: 6px 10px; }
      .title { font-size: 16px; }
      .stat { font-size: 10px; padding: 2px 6px; }
      .game-container { padding: 10px; }
      .grid { gap: 4px; padding: 8px; }
      .cell { min-height: 50px; font-size: 18px; }
      .monster { font-size: 20px; }
      .math-question { font-size: 24px; padding: 10px; }
      
      .controls .btn { font-size: 10px; padding: 8px 10px;}
      .controls .study-btn { font-size: 11px; padding: 10px 12px;}

      .modal-content { padding: 15px; }
      .math-answer-display { font-size: 22px; padding: 10px; width: 70%; }
      .math-numpad button { padding: 12px; font-size: 16px; }

      .level-up { font-size: 14px; padding: 12px 20px; margin: 10px; }
      .reward-popup { font-size: 11px; padding: 6px 10px; margin: 5px; }
    }
    
    @media (max-width: 360px) {
      .stats { gap: 4px; }
      .stat { font-size: 9px; padding: 2px 4px; }
      .cell { min-height: 45px; }
      .monster-list { grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); }
      .controls .btn { font-size: 9px; padding: 6px 8px; }
      .controls .study-btn { font-size: 10px; padding: 8px 10px; }
      .math-question { font-size: 20px; }
      .math-answer-display { font-size: 20px; }
      .math-numpad button { padding: 10px; font-size: 15px; }
    }
  </style>
</head>
<body>
  <div class="effects-container" id="effectsContainer"></div>

  <script>
    for(let i = 0; i < 25; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.width = Math.random() * 6 + 3 + 'px';
      particle.style.height = particle.style.width;
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 6 + 's';
      document.body.appendChild(particle);
    }
  </script>

  <div class="header">
  <div class="title" id="gameTitle" style="cursor: pointer;" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ">ğŸ“ JUKEN MONSTER</div>
  <div class="stats">
    <div class="stat">ğŸ“š Lv.<span id="mathLevel">1</span></div>
    <div class="stat">ğŸ¯ <span id="accuracy">100</span>%</div>
    <div class="stat">ğŸ”¥ <span id="streak">0</span>é€£ç¶š</div>
    <div class="stat">â­ <span id="studyPoints">0</span>P</div>
  </div>
</div>

  <div class="game-container">
    <div class="grid" id="gameGrid">
      </div>

    <div class="controls">
      <button class="btn btn-primary study-btn" id="studyBtn">
        ğŸ“š è¨ˆç®—å•é¡Œ!
      </button>
      <button class="btn btn-shop" id="shopBtn">
        ğŸª ã‚·ãƒ§ãƒƒãƒ—
      </button>
      <button class="btn btn-secondary" id="autoBtn">
        ğŸ¤– è‡ªå‹•å­¦ç¿’ OFF
      </button>
    </div>

    <div class="pokedex">
      <div class="pokedex-title">ğŸ“– ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘ (<span id="discoveredCount">1</span>/15)</div>
      <div class="monster-list" id="monsterList">
        </div>
    </div>
  </div>

  <div id="mathModal" class="modal hidden">
    <div class="modal-content">
      <h2 style="margin-top: 0; font-size: 18px;">ğŸ§® 2æ¡è¨ˆç®—å•é¡Œ</h2>
      <div id="mathQuestion" class="math-question">25 + 37 = ?</div>
      
      <div id="mathAnswerDisplay" class="math-answer-display"></div>
      
      <div id="mathNumpad" class="math-numpad">
        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button data-value="C" class="numpad-action">C</button> <button data-value="0">0</button>
        <button data-value="BS" class="numpad-action">BS</button> </div>
      
      <div style="margin: 15px 0;">
        <button id="submitAnswer" class="btn btn-primary">å›ç­”ã™ã‚‹</button>
        <button id="skipProblem" class="btn btn-secondary">ã‚¹ã‚­ãƒƒãƒ—</button>
      </div>
      <div id="mathFeedback" style="font-size: 14px; min-height: 20px;"></div>
    </div>
  </div>

  <div id="shopModal" class="modal hidden">
    <div class="modal-content">
      <h2 style="margin-top: 0; font-size: 18px;">ğŸª å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆã‚·ãƒ§ãƒƒãƒ—</h2>
      <div style="margin-bottom: 15px; font-size: 14px;">
        æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: â­<span id="shopPoints">0</span>P
      </div>
      <div class="shop-items" id="shopItems">
        </div>
      <button id="closeShop" class="btn btn-secondary" style="margin-top: 15px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    /* ========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ========== */
    let gameState = {
      studyPoints: 0,
      mathLevel: 1,
      mathExp: 0,
      expToNext: 100,
      grid: Array(16).fill(null),
      gridSize: 4, 
      discoveredMonsters: new Set([1]),
      autoStudy: false,
      totalProblems: 0,
      correctProblems: 0,
      consecutiveCorrect: 0,
      shopItems: {
        gridExpand: { bought: false, price: 2000 },
        expBooster: { count: 0, price: 500 },
        rareTicket: { count: 0, price: 1000 },
        autoMerge: { bought: false, price: 5000 },
        skipTicket: { count: 0, price: 200 }
      }
    };

    /* ========== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä½ç½®ç®¡ç† (å¤‰æ›´ãªã—) ========== */
    let effectPositions = [];
    let nextEffectSlot = 0;
    function getNextEffectPosition() { /* ... (å¤‰æ›´ãªã—) ... */
      const slots = [ { top: '20%', left: '50%' },{ top: '30%', left: '30%' },{ top: '25%', left: '70%' },{ top: '35%', left: '50%' },{ top: '40%', left: '25%' }];
      const position = slots[nextEffectSlot % slots.length];
      nextEffectSlot++;
      return position;
    }

    /* ========== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ (å¤‰æ›´ãªã—) ========== */
    const monsters = {1:{emoji:'ğŸ£',name:'ã‘ã„ã•ã‚“ãƒ’ãƒ¨ã‚³',power:1,rarity:1},2:{emoji:'ğŸ°',name:'ãŸã—ã–ã‚“ã‚¦ã‚µã‚®',power:3,rarity:1},3:{emoji:'ğŸ¸',name:'ã²ãã–ã‚“ã‚«ã‚¨ãƒ«',power:7,rarity:2},4:{emoji:'ğŸ¦„',name:'ã™ã†ãŒããƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³',power:15,rarity:3},5:{emoji:'ğŸ‰',name:'ã‘ã„ã•ã‚“ãƒ‰ãƒ©ã‚´ãƒ³',power:31,rarity:4},6:{emoji:'ğŸ¦…',name:'ã“ã†ããã‚¤ãƒ¼ã‚°ãƒ«',power:63,rarity:4},7:{emoji:'ğŸ¦',name:'ã›ã„ã‹ã„ãƒ©ã‚¤ã‚ªãƒ³',power:127,rarity:5},8:{emoji:'ğŸ¯',name:'ã¦ã‚“ã•ã„ã‚¿ã‚¤ã‚¬ãƒ¼',power:255,rarity:5},9:{emoji:'ğŸ¤–',name:'ã‘ã„ã•ã‚“ãƒ­ãƒœãƒƒãƒˆ',power:511,rarity:6},10:{emoji:'ğŸ‘‘',name:'ã™ã†ãŒãã‚­ãƒ³ã‚°',power:1023,rarity:7},11:{emoji:'ğŸŒŸ',name:'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚¹ã‚¿ãƒ¼',power:2047,rarity:8},12:{emoji:'ğŸ’',name:'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼',power:4095,rarity:9},13:{emoji:'ğŸ”¥',name:'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ãƒ•ãƒ¬ã‚¤ãƒ ',power:8191,rarity:10},14:{emoji:'âš¡',name:'ã‚µãƒ³ãƒ€ãƒ¼ã‚¨ãƒ³ãƒšãƒ©ãƒ¼',power:16383,rarity:11},15:{emoji:'ğŸŒˆ',name:'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ã‚´ãƒƒãƒ‰',power:32767,rarity:12}};

    /* ========== ã‚·ãƒ§ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    const shopItemsData = [{id:'gridExpand',name:'ğŸ”§ ã‚°ãƒªãƒƒãƒ‰æ‹¡å¼µ',desc:'4Ã—4 â†’ 5Ã—5ã«æ‹¡å¼µ',price:2000,maxCount:1,effect:()=>expandGrid()},{id:'expBooster',name:'âš¡ çµŒé¨“å€¤ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼',desc:'30åˆ†é–“EXP+50%',price:500,maxCount:99,effect:()=>activateExpBooster()},{id:'rareTicket',name:'ğŸ« ãƒ¬ã‚¢ã‚¬ãƒãƒ£åˆ¸',desc:'ãƒ¬ã‚¢ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç¢ºå®š',price:1000,maxCount:99,effect:()=>useRareTicket()},{id:'autoMerge',name:'ğŸ¤– è‡ªå‹•åˆæˆæ©Ÿèƒ½',desc:'åŒã˜ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è‡ªå‹•åˆæˆ',price:5000,maxCount:1,effect:()=>activateAutoMerge()},{id:'skipTicket',name:'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—åˆ¸',desc:'é›£ã—ã„å•é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—',price:200,maxCount:99,effect:()=>{}}];

    /* ========== DOMè¦ç´  ========== */
    const mathLevelEl = document.getElementById('mathLevel');
    const accuracyEl = document.getElementById('accuracy');
    const streakEl = document.getElementById('streak');
    const studyPointsEl = document.getElementById('studyPoints');
    const gridEl = document.getElementById('gameGrid');
    const studyBtn = document.getElementById('studyBtn');
    const shopBtn = document.getElementById('shopBtn');
    const autoBtn = document.getElementById('autoBtn');
    const mathModal = document.getElementById('mathModal');
    const shopModal = document.getElementById('shopModal');
    const mathQuestion = document.getElementById('mathQuestion');
    // const mathAnswer = document.getElementById('mathAnswer'); // å¤ã„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ†ãƒ³ã‚­ãƒ¼ã«ç½®ãæ›ãˆ
    const mathAnswerDisplay = document.getElementById('mathAnswerDisplay'); // æ–°ã—ã„è¡¨ç¤ºã‚¨ãƒªã‚¢
    const mathNumpad = document.getElementById('mathNumpad'); // ãƒ†ãƒ³ã‚­ãƒ¼æœ¬ä½“
    const submitBtn = document.getElementById('submitAnswer');
    const skipBtn = document.getElementById('skipProblem');
    const mathFeedback = document.getElementById('mathFeedback');
    const closeShopBtn = document.getElementById('closeShop');
    const shopItemsEl = document.getElementById('shopItems');
    const shopPointsEl = document.getElementById('shopPoints');
    const monsterListEl = document.getElementById('monsterList');
    const discoveredCountEl = document.getElementById('discoveredCount');
    const effectsContainer = document.getElementById('effectsContainer');

    let currentProblem = null;
    let audioContext; 
    let numpadInput = ""; // ãƒ†ãƒ³ã‚­ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

    /* ========== ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (å¤‰æ›´ãªã—) ========== */
    function getAudioContext(){if(!audioContext){if(typeof AudioContext!=='undefined'){audioContext=new AudioContext()}else if(typeof webkitAudioContext!=='undefined'){audioContext=new webkitAudioContext()}}return audioContext}
    function playSound(freq,duration=100,type='sine',volume=0.1,rampTime=0.001){const ac=getAudioContext();if(!ac)return;try{const o=ac.createOscillator();const gn=ac.createGain();o.connect(gn);gn.connect(ac.destination);o.frequency.value=freq;o.type=type;gn.gain.setValueAtTime(volume,ac.currentTime);gn.gain.exponentialRampToValueAtTime(rampTime,ac.currentTime+duration/1000);o.start(ac.currentTime);o.stop(ac.currentTime+duration/1000)}catch(e){console.warn("Sound playback failed:",e)}}
    function playSuccessSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.12;const f=[783.99,987.77,1318.51];const d=[0.08,0.08,0.15];const t=['triangle','sine','triangle'];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type=t[i];o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv*(1-i*0.2),n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+d[i]);o.start(n+dl);o.stop(n+dl+d[i]);dl+=d[i]*0.7}}
    function playErrorSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.1;const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='sawtooth';o.frequency.setValueAtTime(180,n);o.frequency.exponentialRampToValueAtTime(120,n+0.25);g.gain.setValueAtTime(bv,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.25);o.start(n);o.stop(n+0.25)}
    function playMergeSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.18;let o=ac.createOscillator();let g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='square';o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(400,n+0.05);g.gain.setValueAtTime(bv,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);o.start(n);o.stop(n+0.1);o=ac.createOscillator();g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='triangle';o.frequency.setValueAtTime(1000,n+0.05);o.frequency.setValueAtTime(1500,n+0.1);o.frequency.exponentialRampToValueAtTime(800,n+0.3);g.gain.setValueAtTime(bv*0.7,n+0.05);g.gain.exponentialRampToValueAtTime(0.001,n+0.3);o.start(n+0.05);o.stop(n+0.3)}
    function playSummonMonsterSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.15;const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='sine';o.frequency.setValueAtTime(300,n);o.frequency.exponentialRampToValueAtTime(1200,n+0.4);g.gain.setValueAtTime(0,n);g.gain.linearRampToValueAtTime(bv,n+0.1);g.gain.exponentialRampToValueAtTime(0.001,n+0.4);o.start(n);o.stop(n+0.4);const o2=ac.createOscillator();const g2=ac.createGain();o2.connect(g2);g2.connect(ac.destination);o2.type='triangle';o2.frequency.setValueAtTime(1500,n+0.15);g2.gain.setValueAtTime(bv*0.6,n+0.15);g2.gain.exponentialRampToValueAtTime(0.001,n+0.15+0.2);o2.start(n+0.15);o2.stop(n+0.15+0.2)}
    function playLevelUpSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.18;const f=[392.00,493.88,587.33,783.99];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='triangle';o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv,n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+0.15);o.start(n+dl);o.stop(n+dl+0.15);dl+=0.1}}
    function playShopPurchaseSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.13;const f=[1046.50,1318.51];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='square';o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv*(1-i*0.3),n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+0.12);o.start(n+dl);o.stop(n+dl+0.12);dl+=0.08}}
    function playGenericClickSound(){playSound(800,50,'triangle',0.05)}

    /* ========== 2æ¡è¨ˆç®—å•é¡Œç”Ÿæˆï¼ˆå¤‰æ›´ãªã—ï¼‰ ========== */
    function generateMathProblem() { /* ... (å¤‰æ›´ãªã—) ... */ 
        const a=Math.floor(Math.random()*90)+10;const b=Math.floor(Math.random()*90)+10;let op,q,ans;if(Math.random()<0.6){op='+';q=`${a} + ${b}`;ans=a+b}else{const l=Math.max(a,b);const s=Math.min(a,b);op='-';q=`${l} - ${s}`;ans=l-s}return{question:q+' = ?',answer:ans,operation:op}
    }

    /* ========== å•é¡Œè¡¨ç¤º (ãƒ†ãƒ³ã‚­ãƒ¼å¯¾å¿œ) ========== */
    function showMathProblem() {
      playGenericClickSound();
      currentProblem = generateMathProblem();
      mathQuestion.textContent = currentProblem.question;
      
      numpadInput = ""; // ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
      mathAnswerDisplay.textContent = "_"; // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€)
      mathAnswerDisplay.classList.remove('correct', 'incorrect'); // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
      
      mathFeedback.textContent = '';
      mathModal.classList.remove('hidden');
      // mathAnswer.focus(); // æ¨™æº–å…¥åŠ›ã¯ä½¿ã‚ãªã„ã®ã§ä¸è¦
    }

    /* ========== ç­”ãˆç¢ºèª (ãƒ†ãƒ³ã‚­ãƒ¼å¯¾å¿œ) ========== */
    function checkAnswer() {
      if (numpadInput === "") return; // ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

      const userAnswer = parseInt(numpadInput);
      const isCorrect = userAnswer === currentProblem.answer;
      
      gameState.totalProblems++;
      
      if (isCorrect) {
        gameState.correctProblems++;
        gameState.consecutiveCorrect++;
        
        let basePoints = 50; 
        const bonusPoints = Math.min(gameState.consecutiveCorrect * 10, 100);
        const totalPoints = basePoints + bonusPoints;
        
        gameState.studyPoints += totalPoints;
        addMathExp(totalPoints);
        
        mathFeedback.textContent = `ğŸ‰ æ­£è§£ï¼ +${totalPoints}ãƒã‚¤ãƒ³ãƒˆ`;
        mathFeedback.style.color = '#4ecdc4';
        mathAnswerDisplay.classList.add('correct');
        mathAnswerDisplay.classList.remove('incorrect');
        playSuccessSound();
        
        if (Math.random() < 0.7) {
          setTimeout(() => {
            summonMonster();
            mathModal.classList.add('hidden');
          }, 1200);
        } else {
          setTimeout(() => {
            mathModal.classList.add('hidden');
          }, 1200);
        }
        
      } else {
        gameState.consecutiveCorrect = 0;
        mathFeedback.textContent = `âŒ ä¸æ­£è§£... ç­”ãˆã¯ ${currentProblem.answer} ã§ã™`;
        mathFeedback.style.color = '#ff6b6b';
        mathAnswerDisplay.classList.add('incorrect');
        mathAnswerDisplay.classList.remove('correct');
        playErrorSound(); 
        
        // ä¸æ­£è§£ã§ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãªã„ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®setTimeoutã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
        setTimeout(() => {
           mathModal.classList.add('hidden');
        }, 1800); 
      }
      
      updateDisplay();
      calculateGridBonuses();
      // numpadInput = ""; // æ¬¡ã®å•é¡Œã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ (showMathProblemã§ã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹)
      // mathAnswerDisplay.textContent = "_";
    }
    
    /* ========== ãƒ†ãƒ³ã‚­ãƒ¼å‡¦ç† ========== */
    mathNumpad.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        playGenericClickSound();

        const value = e.target.dataset.value;

        if (value === 'C') { // Clear
            numpadInput = "";
        } else if (value === 'BS') { // Backspace
            numpadInput = numpadInput.slice(0, -1);
        } else if (numpadInput.length < 5) { // æ•°å­—ãƒœã‚¿ãƒ³ (æœ€å¤§5æ¡ã¾ã§ãªã©)
            numpadInput += value;
        }
        mathAnswerDisplay.textContent = numpadInput || "_"; // ç©ºãªã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
        mathAnswerDisplay.classList.remove('correct', 'incorrect'); // å…¥åŠ›ä¸­ã¯ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    });


    /* ========== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¬å–š (å¤‰æ›´ãªã—) ========== */
    function summonMonster(forceRare=false){const maxCells=gameState.gridSize*gameState.gridSize;const emptyCells=[];for(let i=0;i<maxCells;i++){if(!gameState.grid[i])emptyCells.push(i)}if(emptyCells.length===0){showReward('âŒ ã‚°ãƒªãƒƒãƒ‰ãŒæº€æ¯ã§ã™ï¼');return}playSummonMonsterSound();let monsterId;if(forceRare||gameState.shopItems.rareTicket.count>0){if(gameState.shopItems.rareTicket.count>0){gameState.shopItems.rareTicket.count--}const rareMonsters=[4,5,6,7,8];monsterId=rareMonsters[Math.floor(Math.random()*rareMonsters.length)]}else{const rand=Math.random();if(rand<0.5)monsterId=1;else if(rand<0.75)monsterId=2;else if(rand<0.9)monsterId=3;else monsterId=4}const randomCell=emptyCells[Math.floor(Math.random()*emptyCells.length)];gameState.grid[randomCell]=monsterId;if(!gameState.discoveredMonsters.has(monsterId)){gameState.discoveredMonsters.add(monsterId);updatePokedex();showLevelUp(`ğŸ‰ æ–°ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç™ºè¦‹ï¼ ${monsters[monsterId].emoji} ${monsters[monsterId].name}`);playLevelUpSound()}showReward(`âœ¨ ${monsters[monsterId].emoji} ${monsters[monsterId].name} ã‚’å¬å–šï¼`);renderGrid();if(gameState.shopItems.autoMerge.bought){setTimeout(checkAutoMerge,500)}}

    /* ========== çµŒé¨“å€¤ã‚·ã‚¹ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    function addMathExp(points){gameState.mathExp+=points;let leveledUp=false;while(gameState.mathExp>=gameState.expToNext){gameState.mathExp-=gameState.expToNext;gameState.mathLevel++;gameState.expToNext=Math.floor(gameState.expToNext*1.3);showLevelUp(`ğŸ“ æ•°å­¦ãƒ¬ãƒ™ãƒ«${gameState.mathLevel}é”æˆï¼`);leveledUp=true}if(leveledUp){playLevelUpSound()}}

    /* ========== ã‚°ãƒªãƒƒãƒ‰æ‹¡å¼µ (å¤‰æ›´ãªã—) ========== */
    function expandGrid(){if(gameState.gridSize>=5)return;gameState.gridSize=5;const newGrid=Array(25).fill(null);for(let i=0;i<16;i++){if(gameState.grid[i]){newGrid[i]=gameState.grid[i]}}gameState.grid=newGrid;gridEl.style.gridTemplateColumns='repeat(5, 1fr)';for(let i=16;i<25;i++){const cell=document.createElement('div');cell.className='cell';cell.dataset.index=i;cell.addEventListener('click',()=>handleCellClick(i));cell.addEventListener('dragover',handleDragOver);cell.addEventListener('drop',(e)=>handleDrop(e,i));gridEl.appendChild(cell)}renderGrid();showLevelUp('ğŸ”§ ã‚°ãƒªãƒƒãƒ‰ãŒ5Ã—5ã«æ‹¡å¼µã•ã‚Œã¾ã—ãŸï¼');playLevelUpSound()}

    /* ========== ã‚°ãƒªãƒƒãƒ‰ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®— (å¤‰æ›´ãªã—) ========== */
    function calculateGridBonuses(){document.querySelectorAll('.cell').forEach(c=>c.classList.remove('bonus'));const cells=document.querySelectorAll('.cell');cells.forEach(c=>{if(c&&c.classList){c.classList.remove('bonus')}});const maxCells=gameState.gridSize*gameState.gridSize;let bonusMultiplier=1.0;for(let r=0;r<gameState.gridSize;r++){const rowMonsters=[];for(let col=0;col<gameState.gridSize;col++){const i=r*gameState.gridSize+col;if(gameState.grid[i]){rowMonsters.push(gameState.grid[i])}}const monsterCounts={};rowMonsters.forEach(id=>{monsterCounts[id]=(monsterCounts[id]||0)+1});for(const[mId,cnt]of Object.entries(monsterCounts)){if(cnt>=3){bonusMultiplier+=0.5;for(let col=0;col<gameState.gridSize;col++){const i=r*gameState.gridSize+col;if(gameState.grid[i]==mId&&gridEl.children[i]){gridEl.children[i].classList.add('bonus')}}}}}const corners=[0,gameState.gridSize-1,maxCells-gameState.gridSize,maxCells-1];let cornerRareCount=0;corners.forEach(i=>{if(gameState.grid[i]&&monsters[gameState.grid[i]].rarity>=5){cornerRareCount++;if(gridEl.children[i])gridEl.children[i].classList.add('bonus')}});if(cornerRareCount>=2){bonusMultiplier+=0.3}return bonusMultiplier}

    /* ========== è‡ªå‹•åˆæˆ (å¤‰æ›´ãªã—) ========== */
    function checkAutoMerge(){if(!gameState.shopItems.autoMerge.bought)return;const maxCells=gameState.gridSize*gameState.gridSize;for(let i=0;i<maxCells-1;i++){for(let j=i+1;j<maxCells;j++){const m1=gameState.grid[i];const m2=gameState.grid[j];if(m1&&m2&&m1===m2&&m1<15){mergeMonsters(i,j);return}}}}

    /* ========== ã‚·ãƒ§ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    function initShop(){shopItemsEl.innerHTML='';shopItemsData.forEach(item=>{const itemEl=document.createElement('div');itemEl.className='shop-item';const owned=gameState.shopItems[item.id];const canBuy=gameState.studyPoints>=item.price&&(owned.count<item.maxCount||!owned.bought);itemEl.innerHTML=`<div class="shop-item-info"><div class="shop-item-name">${item.name}</div><div class="shop-item-desc">${item.desc}</div>${item.maxCount>1?`<div class="shop-item-desc">æ‰€æŒ: ${owned.count||0}</div>`:''}</div><div style="display:flex;align-items:center;"><div class="shop-item-price">â­${item.price}</div><button class="btn ${canBuy?'btn-primary':'btn-secondary'}" ${canBuy?'':'disabled'} onclick="buyItem('${item.id}')">${canBuy?'è³¼å…¥':(owned.bought?'è³¼å…¥æ¸ˆ':'ä¸è¶³')}</button></div>`;shopItemsEl.appendChild(itemEl)})}
    function buyItem(itemId){const item=shopItemsData.find(i=>i.id===itemId);const owned=gameState.shopItems[itemId];if(gameState.studyPoints>=item.price&&(owned.count<item.maxCount||!owned.bought)){gameState.studyPoints-=item.price;if(item.maxCount===1){owned.bought=true}else{owned.count=(owned.count||0)+1}item.effect();initShop();updateDisplay();showReward(`ğŸ›’ ${item.name} ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);playShopPurchaseSound()}else{playErrorSound()}}

    /* ========== ã‚·ãƒ§ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœ (å¤‰æ›´ãªã—) ========== */
    function activateExpBooster(){showLevelUp('âš¡ 30åˆ†é–“çµŒé¨“å€¤+50%ï¼');gameState.expBoosterRemaining=10;playLevelUpSound()}
    function useRareTicket(){showLevelUp('ğŸ« ãƒ¬ã‚¢ã‚¬ãƒãƒ£åˆ¸ã‚’ç²å¾—ï¼');playShopPurchaseSound()}
    function activateAutoMerge(){showLevelUp('ğŸ¤– è‡ªå‹•åˆæˆæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');playLevelUpSound()}

    /* ========== è¡¨ç¤ºæ›´æ–° (å¤‰æ›´ãªã—) ========== */
    function updateDisplay(){mathLevelEl.textContent=gameState.mathLevel;studyPointsEl.textContent=gameState.studyPoints.toLocaleString();shopPointsEl.textContent=gameState.studyPoints.toLocaleString();streakEl.textContent=gameState.consecutiveCorrect;const acc=gameState.totalProblems>0?Math.round((gameState.correctProblems/gameState.totalProblems)*100):100;accuracyEl.textContent=acc;discoveredCountEl.textContent=gameState.discoveredMonsters.size}

    /* ========== ã‚°ãƒªãƒƒãƒ‰æç”» (å¤‰æ›´ãªã—) ========== */
    function renderGrid(){const maxCells=gameState.gridSize*gameState.gridSize;const cells=gridEl.children;for(let i=0;i<maxCells;i++){if(i<cells.length){const cell=cells[i];const mId=gameState.grid[i];if(mId){const m=monsters[mId];cell.innerHTML=`<div class="monster">${m.emoji}</div>`;cell.className='cell occupied';cell.draggable=true}else{cell.innerHTML='';cell.className='cell';cell.draggable=false}}}}

    /* ========== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— (å¤‰æ›´ãªã—) ========== */
    let draggedIndex=null;function handleDragStart(e,index){draggedIndex=index;e.target.closest('.cell').classList.add('dragging');playGenericClickSound()}
    function handleDragOver(e){e.preventDefault();const cell=e.target.closest('.cell');if(cell&&!cell.classList.contains('drop-target')){document.querySelectorAll('.cell.drop-target').forEach(c=>c.classList.remove('drop-target'));cell.classList.add('drop-target')}}
    function handleDragLeave(e){const cell=e.target.closest('.cell');if(cell){cell.classList.remove('drop-target')}}
    function handleDrop(e,targetIndex){e.preventDefault();document.querySelectorAll('.cell').forEach(c=>c.classList.remove('drop-target','dragging'));if(draggedIndex===null||draggedIndex===targetIndex)return;const dId=gameState.grid[draggedIndex];const tId=gameState.grid[targetIndex];if(dId&&tId&&dId===tId){mergeMonsters(draggedIndex,targetIndex)}else if(!tId){gameState.grid[targetIndex]=dId;gameState.grid[draggedIndex]=null;playSound(300,80,'triangle',0.08);renderGrid();calculateGridBonuses()}draggedIndex=null}

    /* ========== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åˆæˆ (å¤‰æ›´ãªã—) ========== */
    function mergeMonsters(idx1,idx2){const mId=gameState.grid[idx1];const nId=mId+1;if(nId<=15){gameState.grid[idx2]=nId;gameState.grid[idx1]=null;if(!gameState.discoveredMonsters.has(nId)){gameState.discoveredMonsters.add(nId);updatePokedex();showLevelUp(`ğŸ‰ æ–°ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼èª•ç”Ÿï¼ ${monsters[nId].emoji} ${monsters[nId].name}`);playLevelUpSound()}showMergeEffect(idx2);const expGain=monsters[nId].power;addMathExp(Math.floor(expGain/10));gameState.studyPoints+=Math.floor(expGain/20);playMergeSound();renderGrid();updateDisplay();calculateGridBonuses()}}

    /* ========== å›³é‘‘ã‚·ã‚¹ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    function initPokedex(){for(let i=1;i<=15;i++){const card=document.createElement('div');card.className='monster-card';card.innerHTML=`<div class="monster-emoji">${gameState.discoveredMonsters.has(i)?monsters[i].emoji:'â“'}</div><div class="monster-name">${gameState.discoveredMonsters.has(i)?monsters[i].name:'???'}</div>`;if(gameState.discoveredMonsters.has(i)){card.classList.add('discovered')}monsterListEl.appendChild(card)}}
    function updatePokedex(){const cards=monsterListEl.children;for(let i=1;i<=15;i++){const card=cards[i-1];if(gameState.discoveredMonsters.has(i)){card.innerHTML=`<div class="monster-emoji">${monsters[i].emoji}</div><div class="monster-name">${monsters[i].name}</div>`;card.classList.add('discovered')}}}

    /* ========== è‡ªå‹•å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    function toggleAutoStudy(){playGenericClickSound();gameState.autoStudy=!gameState.autoStudy;autoBtn.textContent=gameState.autoStudy?'ğŸ¤– è‡ªå‹•å­¦ç¿’ ON':'ğŸ¤– è‡ªå‹•å­¦ç¿’ OFF';autoBtn.style.background=gameState.autoStudy?'linear-gradient(45deg,#4ecdc4,#44a08d)':'linear-gradient(45deg,#a8e6cf,#88d8c0)'}
    function startAutoStudy(){setInterval(()=>{if(!gameState.autoStudy)return;gameState.totalProblems++;if(Math.random()<0.8){gameState.correctProblems++;gameState.consecutiveCorrect++;const pts=25;gameState.studyPoints+=pts;addMathExp(pts);if(Math.random()<0.3){summonMonster()}showReward(`ğŸ¤– è‡ªå‹•å­¦ç¿’: +${pts}P`);playSound(600,80,'sine',0.05)}else{gameState.consecutiveCorrect=0;playSound(150,100,'square',0.05)}updateDisplay();calculateGridBonuses()},8000)}

    /* ========== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° (å¤‰æ›´ãªã—) ========== */
    function showMergeEffect(cellIndex){if(!gridEl.children[cellIndex])return;const cell=gridEl.children[cellIndex];const rect=cell.getBoundingClientRect();const effect=document.createElement('div');effect.className='merge-effect';effect.textContent='âœ¨ğŸ’«â­';effect.style.left=rect.left+rect.width/2+'px';effect.style.top=rect.top+rect.height/2+'px';effect.style.transform='translate(-50%,-50%)';effectsContainer.appendChild(effect);setTimeout(()=>effect.remove(),800)}
    function showLevelUp(message){const pos=getNextEffectPosition();const popup=document.createElement('div');popup.className='level-up';popup.textContent=message;popup.style.top=pos.top;popup.style.left=pos.left;popup.style.transform='translate(-50%,-50%)';effectsContainer.appendChild(popup);setTimeout(()=>popup.remove(),2500)}
    function showReward(message){const popup=document.createElement('div');popup.className='reward-popup';popup.textContent=message;popup.style.top='20px';popup.style.right='20px';effectsContainer.appendChild(popup);setTimeout(()=>popup.remove(),2500)}

    /* ========== åˆæœŸåŒ– ========== */
    function initGame() {
      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.addEventListener('click', () => handleCellClick(i));
        cell.addEventListener('dragstart', (e) => handleDragStart(e, i));
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragleave', handleDragLeave); 
        cell.addEventListener('drop', (e) => handleDrop(e, i));
        gridEl.appendChild(cell);
      }

      const gameTitle = document.getElementById('gameTitle');
      let clickCount = 0;
      let clickTimer = null;
      gameTitle.addEventListener('click', () => { /* ... (å¤‰æ›´ãªã—ã€ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½) ... */ 
        playGenericClickSound();clickCount++;if(clickCount===1){showReward('ğŸ”„ ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆ');clickTimer=setTimeout(()=>{clickCount=0},3000)}else if(clickCount===2){clearTimeout(clickTimer);clickCount=0;if(confirm('ğŸ“ JUKEN MONSTERã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ï¼š\nãƒ»å­¦ç¿’ãƒ¬ãƒ™ãƒ«ã¨çµŒé¨“å€¤\nãƒ»åé›†ã—ãŸãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼\nãƒ»å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ\nãƒ»ã‚·ãƒ§ãƒƒãƒ—è³¼å…¥ã‚¢ã‚¤ãƒ†ãƒ \n\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){resetGame()}}
      });

      gameState.grid[0] = 1;
      
      studyBtn.addEventListener('click', showMathProblem);
      shopBtn.addEventListener('click', () => { playGenericClickSound(); initShop(); shopModal.classList.remove('hidden'); });
      autoBtn.addEventListener('click', toggleAutoStudy);
      submitBtn.addEventListener('click', checkAnswer); // ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å¾Œã€ã“ã®ãƒœã‚¿ãƒ³ã§å›ç­”
      skipBtn.addEventListener('click', () => { /* ... (å¤‰æ›´ãªã—ã€ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½) ... */ 
        playGenericClickSound();if(gameState.shopItems.skipTicket.count>0){gameState.shopItems.skipTicket.count--;showReward('â­ï¸ ã‚¹ã‚­ãƒƒãƒ—åˆ¸ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ');playShopPurchaseSound()}else{playErrorSound()}mathModal.classList.add('hidden')
      });
      closeShopBtn.addEventListener('click', () => { playGenericClickSound(); shopModal.classList.add('hidden'); });
      
      // mathAnswer.addEventListener('keypress', ...); // æ¨™æº–å…¥åŠ›ã¯ä½¿ã‚ãªã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤

      initPokedex();
      updateDisplay();
      renderGrid(); 
      calculateGridBonuses();
      startAutoStudy();
    }

    /* ========== ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ (å¤‰æ›´ãªã—) ========== */
    function resetGame(){localStorage.removeItem('jukenMonster');showLevelUp('ğŸ”„ ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼\næ–°ã—ã„å†’é™ºãŒå§‹ã¾ã‚Šã¾ã™ï¼');playLevelUpSound();setTimeout(()=>location.reload(),2000)}

    /* ========== ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç† (å¤‰æ›´ãªã—) ========== */
    function handleCellClick(idx){if(!gameState.grid[idx])return;const mId=gameState.grid[idx];const m=monsters[mId];showReward(`${m.emoji} ${m.name} (âš¡${m.power})`);playSound(400+m.rarity*50,80,'sine',0.07)}

    /* ========== è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ  (å¤‰æ›´ãªã—) ========== */
    function saveGame(){localStorage.setItem('jukenMonster',JSON.stringify({...gameState,discoveredMonsters:Array.from(gameState.discoveredMonsters)}))}
    function loadGame(){const saved=localStorage.getItem('jukenMonster');if(saved){const data=JSON.parse(saved);gameState={...gameState,...data,discoveredMonsters:new Set(data.discoveredMonsters||[1])};if(gameState.gridSize===5&&gridEl.children.length<25){gridEl.style.gridTemplateColumns='repeat(5,1fr)';for(let i=gridEl.children.length;i<25;i++){const cell=document.createElement('div');cell.className='cell';cell.dataset.index=i;gridEl.appendChild(cell)}}}}

    /* ========== ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ (å¤‰æ›´ãªã—) ========== */
    let touchStartX,touchStartY,touchEndX,touchEndY;let isTouchDragging=false;let touchDraggedIndex=null;
    gridEl.addEventListener('touchstart',(e)=>{const t=e.touches[0];touchStartX=t.clientX;touchStartY=t.clientY;const c=e.target.closest('.cell');if(c&&c.dataset.index){touchDraggedIndex=parseInt(c.dataset.index);if(gameState.grid[touchDraggedIndex]){isTouchDragging=true;c.classList.add('dragging');e.preventDefault();playGenericClickSound()}}},{passive:false});
    gridEl.addEventListener('touchmove',(e)=>{if(isTouchDragging){e.preventDefault();const t=e.touches[0];touchEndX=t.clientX;touchEndY=t.clientY;const elB=document.elementFromPoint(touchEndX,touchEndY);const tC=elB?.closest('.cell');document.querySelectorAll('.cell.drop-target').forEach(c=>c.classList.remove('drop-target'));if(tC&&tC.dataset.index!==touchDraggedIndex?.toString()){tC.classList.add('drop-target')}}},{passive:false});
    gridEl.addEventListener('touchend',(e)=>{if(isTouchDragging){const elB=document.elementFromPoint(touchEndX,touchEndY);const tC=elB?.closest('.cell');if(tC&&tC.dataset.index){const tIdx=parseInt(tC.dataset.index);if(tIdx!==touchDraggedIndex){const dId=gameState.grid[touchDraggedIndex];const tgId=gameState.grid[tIdx];if(dId&&tgId&&dId===tgId){mergeMonsters(touchDraggedIndex,tIdx)}else if(!tgId&&dId){gameState.grid[tIdx]=dId;gameState.grid[touchDraggedIndex]=null;playSound(300,80,'triangle',0.08);renderGrid();calculateGridBonuses()}}}document.querySelectorAll('.cell').forEach(c=>c.classList.remove('drop-target','dragging'));isTouchDragging=false;touchDraggedIndex=null}});

    /* ========== ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« (å¤‰æ›´ãªã—) ========== */
    function showTutorial(){const msgs=['ğŸ“ JUKEN MONSTERã¸ã‚ˆã†ã“ãï¼','ğŸ“š 2æ¡ã®è¨ˆç®—å•é¡Œã‚’è§£ã„ã¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å¬å–šã—ã‚ˆã†ï¼','ğŸ§® æ­£è§£ã™ã‚Œã°ã™ã‚‹ã»ã©å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆãŒè²¯ã¾ã‚‹ï¼','âœ¨ åŒã˜ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åŒå£«ã‚’ãã£ã¤ã‘ã¦é€²åŒ–ã•ã›ã‚ˆã†ï¼','ğŸª ã‚·ãƒ§ãƒƒãƒ—ã§ä¾¿åˆ©ã‚¢ã‚¤ãƒ†ãƒ ã‚’è³¼å…¥ã§ãã‚‹ï¼','ğŸ† å…¨15ç¨®é¡ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘å®Œæˆã‚’ç›®æŒ‡ãã†ï¼'];let idx=0;function showNext(){if(idx<msgs.length){showLevelUp(msgs[idx]);if(idx>0)playSound(600+idx*50,150,'sine',0.08);idx++;setTimeout(showNext,3000)}}showNext()}

    /* ========== ã‚²ãƒ¼ãƒ é–‹å§‹ ========== */
    window.addEventListener('load', () => {
      loadGame();
      initGame(); 
      setInterval(saveGame, 10000);
      if (!localStorage.getItem('jukenMonster')) {
        setTimeout(showTutorial, 1000);
      }
    });
  </script>
</body>
</html>