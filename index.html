<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>🎓 JUKEN MONSTER 🎓</title>

  <style>
    html, body {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
    }
    
    /* パーティクル背景 */
    .particle {
      position: absolute;
      background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); opacity: 0.5; }
      50% { transform: translateY(-15px); opacity: 0.8; }
    }
    
    /* ヘッダー */
    .header {
      background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding: 8px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .title {
      font-size: 18px;
      font-weight: 900;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      flex-shrink: 0;
    }

    .title:hover {
      transform: scale(1.05);
      transition: transform 0.2s ease;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .title:active {
      transform: scale(0.95);
    }
    
    .stats {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .stat {
      background: rgba(255,255,255,0.2);
      padding: 3px 8px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .game-container {
      padding: 15px;
      max-width: 420px;
      margin: 0 auto;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 18px;
      margin-bottom: 15px;
      backdrop-filter: blur(10px);
    }
    
    .cell {
      aspect-ratio: 1;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      min-height: 60px;
    }
    
    .cell:hover {
      transform: scale(1.05);
      background: rgba(255,255,255,0.2);
    }
    
    .cell.occupied {
      background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
      border: 2px solid rgba(255,255,255,0.4);
      animation: monsterPulse 2s ease-in-out infinite;
    }
    
    .cell.bonus {
      border: 2px solid #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    .cell.dragging {
      transform: scale(1.1);
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .cell.drop-target {
      border: 3px solid #4ecdc4;
      background: rgba(78, 205, 196, 0.2);
    }
    
    @keyframes monsterPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    .monster {
      font-size: 24px;
      animation: monsterIdle 3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
    }
    
    @keyframes monsterIdle {
      0%, 100% { transform: rotate(-2deg); }
      50% { transform: rotate(2deg); }
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      color: white;
      font-family: inherit;
      white-space: nowrap; /* ボタン内テキストの折り返しを防ぐ */
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #a8e6cf, #88d8c0);
      box-shadow: 0 4px 12px rgba(168, 230, 207, 0.4);
    }
    
    .btn-shop {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #333;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .study-btn {
      background: linear-gradient(45deg, #ff6b6b, #ffa500, #ff6b6b);
      background-size: 200% 200%;
      animation: studyShine 2s ease-in-out infinite;
      border: 2px solid #ffd700;
      font-size: 14px; /* 少し大きめ */
      padding: 12px 20px; /* 少し大きめ */
      flex-shrink: 0; /* このボタンは縮みにくくする */
    }
    
    @keyframes studyShine {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.hidden {
      display: none;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 20px; /* 少し調整 */
      text-align: center;
      max-width: 380px;
      width: 100%;
      color: white;
      animation: modalSlideIn 0.5s ease-out;
      max-height: 90vh; /* 少し拡大 */
      overflow-y: auto;
    }
    
    @keyframes modalSlideIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .math-question {
      font-size: 28px; /* 少し調整 */
      font-weight: bold;
      margin: 15px 0; /* 少し調整 */
      padding: 15px; /* 少し調整 */
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      min-height: 45px; /* 少し調整 */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === 計算問題のカスタム入力 === */
    .math-answer-display {
        background: rgba(255,255,255,0.9);
        color: #333;
        border-radius: 10px;
        padding: 12px;
        font-size: 24px;
        font-weight: bold;
        min-height: 30px; /* 高さを確保 */
        margin: 15px auto;
        width: 80%;
        max-width: 200px;
        text-align: center;
        letter-spacing: 2px;
        border: 2px solid rgba(255,255,255,0.7);
    }
    .math-numpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 20px 0;
    }
    .math-numpad button {
        padding: 15px; /* 十分なタップ領域 */
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        background: rgba(255,255,255,0.3);
        color: white;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .math-numpad button:hover {
        background: rgba(255,255,255,0.5);
    }
    .math-numpad button:active {
        background: rgba(255,255,255,0.7);
    }
    .numpad-action { /* Backspace, Clear for example */
        background: rgba(255,107,107,0.5) !important; /* 目立つ色 */
    }
     .numpad-zero {
        grid-column: span 3; /* 0ボタンを広くする例 */
    }
    /* === ここまでカスタム入力 === */
    
    .shop-items { /* ... (変更なし) ... */ }
    .shop-item { /* ... (変更なし) ... */ }
    /* ... 他の既存スタイル ... */

    /* コントロールボタンのレイアウト調整 */
    .controls {
      display: flex;
      gap: 6px; /* 少し縮小 */
      justify-content: center;
      align-items: center; /* ボタンの縦位置を揃える */
      margin-bottom: 15px;
      flex-wrap: nowrap; /* 折り返しを禁止 */
      width: 100%; /* 親要素の幅を基準に */
      overflow-x: auto; /* 万が一はみ出た場合のスクロール処理（基本的には不要なはず） */
    }
    .controls .btn {
      padding: 8px 12px; /* 全体的に少し縮小 */
      font-size: 11px; /* 全体的に少し縮小 */
      flex-shrink: 1; /* 必要に応じて縮小許可 */
      min-width: 0; /* flex-shrinkを有効にするため */
    }
    .controls .study-btn {
      padding: 10px 15px; /* 個別に調整 */
      font-size: 12px; /* 個別に調整 */
      flex-shrink: 0; /* このボタンは縮みにくくする */
    }
     .controls .btn-shop {
        flex-grow: 1; /* ショップボタンに余白を割り当てる (オプション) */
        text-align: center;
    }
    .controls .btn-secondary { /* 自動学習ボタン */
        flex-grow: 1; /* 自動学習ボタンにも余白を割り当てる (オプション) */
        text-align: center;
    }


    .effects-container { /* ... (変更なし) ... */ }
    .merge-effect { /* ... (変更なし) ... */ }
    /* ... (以下、スタイルはほぼ変更なし、必要に応じて微調整) ... */
    
    /* スマホ対応 */
    @media (max-width: 480px) {
      .header { padding: 6px 10px; }
      .title { font-size: 16px; }
      .stat { font-size: 10px; padding: 2px 6px; }
      .game-container { padding: 10px; }
      .grid { gap: 4px; padding: 8px; }
      .cell { min-height: 50px; font-size: 18px; }
      .monster { font-size: 20px; }
      .math-question { font-size: 24px; padding: 10px; }
      
      .controls .btn { font-size: 10px; padding: 8px 10px;}
      .controls .study-btn { font-size: 11px; padding: 10px 12px;}

      .modal-content { padding: 15px; }
      .math-answer-display { font-size: 22px; padding: 10px; width: 70%; }
      .math-numpad button { padding: 12px; font-size: 16px; }

      .level-up { font-size: 14px; padding: 12px 20px; margin: 10px; }
      .reward-popup { font-size: 11px; padding: 6px 10px; margin: 5px; }
    }
    
    @media (max-width: 360px) {
      .stats { gap: 4px; }
      .stat { font-size: 9px; padding: 2px 4px; }
      .cell { min-height: 45px; }
      .monster-list { grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); }
      .controls .btn { font-size: 9px; padding: 6px 8px; }
      .controls .study-btn { font-size: 10px; padding: 8px 10px; }
      .math-question { font-size: 20px; }
      .math-answer-display { font-size: 20px; }
      .math-numpad button { padding: 10px; font-size: 15px; }
    }
  </style>
</head>
<body>
  <div class="effects-container" id="effectsContainer"></div>

  <script>
    for(let i = 0; i < 25; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.width = Math.random() * 6 + 3 + 'px';
      particle.style.height = particle.style.width;
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 6 + 's';
      document.body.appendChild(particle);
    }
  </script>

  <div class="header">
  <div class="title" id="gameTitle" style="cursor: pointer;" title="クリックでゲームリセット">🎓 JUKEN MONSTER</div>
  <div class="stats">
    <div class="stat">📚 Lv.<span id="mathLevel">1</span></div>
    <div class="stat">🎯 <span id="accuracy">100</span>%</div>
    <div class="stat">🔥 <span id="streak">0</span>連続</div>
    <div class="stat">⭐ <span id="studyPoints">0</span>P</div>
  </div>
</div>

  <div class="game-container">
    <div class="grid" id="gameGrid">
      </div>

    <div class="controls">
      <button class="btn btn-primary study-btn" id="studyBtn">
        📚 計算問題!
      </button>
      <button class="btn btn-shop" id="shopBtn">
        🏪 ショップ
      </button>
      <button class="btn btn-secondary" id="autoBtn">
        🤖 自動学習 OFF
      </button>
    </div>

    <div class="pokedex">
      <div class="pokedex-title">📖 モンスター図鑑 (<span id="discoveredCount">1</span>/15)</div>
      <div class="monster-list" id="monsterList">
        </div>
    </div>
  </div>

  <div id="mathModal" class="modal hidden">
    <div class="modal-content">
      <h2 style="margin-top: 0; font-size: 18px;">🧮 2桁計算問題</h2>
      <div id="mathQuestion" class="math-question">25 + 37 = ?</div>
      
      <div id="mathAnswerDisplay" class="math-answer-display"></div>
      
      <div id="mathNumpad" class="math-numpad">
        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button data-value="C" class="numpad-action">C</button> <button data-value="0">0</button>
        <button data-value="BS" class="numpad-action">BS</button> </div>
      
      <div style="margin: 15px 0;">
        <button id="submitAnswer" class="btn btn-primary">回答する</button>
        <button id="skipProblem" class="btn btn-secondary">スキップ</button>
      </div>
      <div id="mathFeedback" style="font-size: 14px; min-height: 20px;"></div>
    </div>
  </div>

  <div id="shopModal" class="modal hidden">
    <div class="modal-content">
      <h2 style="margin-top: 0; font-size: 18px;">🏪 学習ポイントショップ</h2>
      <div style="margin-bottom: 15px; font-size: 14px;">
        所持ポイント: ⭐<span id="shopPoints">0</span>P
      </div>
      <div class="shop-items" id="shopItems">
        </div>
      <button id="closeShop" class="btn btn-secondary" style="margin-top: 15px;">閉じる</button>
    </div>
  </div>

  <script>
    /* ========== ゲーム状態 ========== */
    let gameState = {
      studyPoints: 0,
      mathLevel: 1,
      mathExp: 0,
      expToNext: 100,
      grid: Array(16).fill(null),
      gridSize: 4, 
      discoveredMonsters: new Set([1]),
      autoStudy: false,
      totalProblems: 0,
      correctProblems: 0,
      consecutiveCorrect: 0,
      shopItems: {
        gridExpand: { bought: false, price: 2000 },
        expBooster: { count: 0, price: 500 },
        rareTicket: { count: 0, price: 1000 },
        autoMerge: { bought: false, price: 5000 },
        skipTicket: { count: 0, price: 200 }
      }
    };

    /* ========== エフェクト位置管理 (変更なし) ========== */
    let effectPositions = [];
    let nextEffectSlot = 0;
    function getNextEffectPosition() { /* ... (変更なし) ... */
      const slots = [ { top: '20%', left: '50%' },{ top: '30%', left: '30%' },{ top: '25%', left: '70%' },{ top: '35%', left: '50%' },{ top: '40%', left: '25%' }];
      const position = slots[nextEffectSlot % slots.length];
      nextEffectSlot++;
      return position;
    }

    /* ========== モンスターデータ (変更なし) ========== */
    const monsters = {1:{emoji:'🐣',name:'けいさんヒヨコ',power:1,rarity:1},2:{emoji:'🐰',name:'たしざんウサギ',power:3,rarity:1},3:{emoji:'🐸',name:'ひきざんカエル',power:7,rarity:2},4:{emoji:'🦄',name:'すうがくユニコーン',power:15,rarity:3},5:{emoji:'🐉',name:'けいさんドラゴン',power:31,rarity:4},6:{emoji:'🦅',name:'こうそくイーグル',power:63,rarity:4},7:{emoji:'🦁',name:'せいかいライオン',power:127,rarity:5},8:{emoji:'🐯',name:'てんさいタイガー',power:255,rarity:5},9:{emoji:'🤖',name:'けいさんロボット',power:511,rarity:6},10:{emoji:'👑',name:'すうがくキング',power:1023,rarity:7},11:{emoji:'🌟',name:'レジェンドスター',power:2047,rarity:8},12:{emoji:'💎',name:'ダイヤモンドマスター',power:4095,rarity:9},13:{emoji:'🔥',name:'インフィニティフレイム',power:8191,rarity:10},14:{emoji:'⚡',name:'サンダーエンペラー',power:16383,rarity:11},15:{emoji:'🌈',name:'レインボーゴッド',power:32767,rarity:12}};

    /* ========== ショップアイテム (変更なし) ========== */
    const shopItemsData = [{id:'gridExpand',name:'🔧 グリッド拡張',desc:'4×4 → 5×5に拡張',price:2000,maxCount:1,effect:()=>expandGrid()},{id:'expBooster',name:'⚡ 経験値ブースター',desc:'30分間EXP+50%',price:500,maxCount:99,effect:()=>activateExpBooster()},{id:'rareTicket',name:'🎫 レアガチャ券',desc:'レアモンスター確定',price:1000,maxCount:99,effect:()=>useRareTicket()},{id:'autoMerge',name:'🤖 自動合成機能',desc:'同じモンスター自動合成',price:5000,maxCount:1,effect:()=>activateAutoMerge()},{id:'skipTicket',name:'⏭️ スキップ券',desc:'難しい問題をスキップ',price:200,maxCount:99,effect:()=>{}}];

    /* ========== DOM要素 ========== */
    const mathLevelEl = document.getElementById('mathLevel');
    const accuracyEl = document.getElementById('accuracy');
    const streakEl = document.getElementById('streak');
    const studyPointsEl = document.getElementById('studyPoints');
    const gridEl = document.getElementById('gameGrid');
    const studyBtn = document.getElementById('studyBtn');
    const shopBtn = document.getElementById('shopBtn');
    const autoBtn = document.getElementById('autoBtn');
    const mathModal = document.getElementById('mathModal');
    const shopModal = document.getElementById('shopModal');
    const mathQuestion = document.getElementById('mathQuestion');
    // const mathAnswer = document.getElementById('mathAnswer'); // 古い入力フィールドはテンキーに置き換え
    const mathAnswerDisplay = document.getElementById('mathAnswerDisplay'); // 新しい表示エリア
    const mathNumpad = document.getElementById('mathNumpad'); // テンキー本体
    const submitBtn = document.getElementById('submitAnswer');
    const skipBtn = document.getElementById('skipProblem');
    const mathFeedback = document.getElementById('mathFeedback');
    const closeShopBtn = document.getElementById('closeShop');
    const shopItemsEl = document.getElementById('shopItems');
    const shopPointsEl = document.getElementById('shopPoints');
    const monsterListEl = document.getElementById('monsterList');
    const discoveredCountEl = document.getElementById('discoveredCount');
    const effectsContainer = document.getElementById('effectsContainer');

    let currentProblem = null;
    let audioContext; 
    let numpadInput = ""; // テンキーからの入力を保持する変数

    /* ========== サウンドエフェクト (変更なし) ========== */
    function getAudioContext(){if(!audioContext){if(typeof AudioContext!=='undefined'){audioContext=new AudioContext()}else if(typeof webkitAudioContext!=='undefined'){audioContext=new webkitAudioContext()}}return audioContext}
    function playSound(freq,duration=100,type='sine',volume=0.1,rampTime=0.001){const ac=getAudioContext();if(!ac)return;try{const o=ac.createOscillator();const gn=ac.createGain();o.connect(gn);gn.connect(ac.destination);o.frequency.value=freq;o.type=type;gn.gain.setValueAtTime(volume,ac.currentTime);gn.gain.exponentialRampToValueAtTime(rampTime,ac.currentTime+duration/1000);o.start(ac.currentTime);o.stop(ac.currentTime+duration/1000)}catch(e){console.warn("Sound playback failed:",e)}}
    function playSuccessSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.12;const f=[783.99,987.77,1318.51];const d=[0.08,0.08,0.15];const t=['triangle','sine','triangle'];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type=t[i];o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv*(1-i*0.2),n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+d[i]);o.start(n+dl);o.stop(n+dl+d[i]);dl+=d[i]*0.7}}
    function playErrorSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.1;const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='sawtooth';o.frequency.setValueAtTime(180,n);o.frequency.exponentialRampToValueAtTime(120,n+0.25);g.gain.setValueAtTime(bv,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.25);o.start(n);o.stop(n+0.25)}
    function playMergeSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.18;let o=ac.createOscillator();let g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='square';o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(400,n+0.05);g.gain.setValueAtTime(bv,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);o.start(n);o.stop(n+0.1);o=ac.createOscillator();g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='triangle';o.frequency.setValueAtTime(1000,n+0.05);o.frequency.setValueAtTime(1500,n+0.1);o.frequency.exponentialRampToValueAtTime(800,n+0.3);g.gain.setValueAtTime(bv*0.7,n+0.05);g.gain.exponentialRampToValueAtTime(0.001,n+0.3);o.start(n+0.05);o.stop(n+0.3)}
    function playSummonMonsterSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.15;const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='sine';o.frequency.setValueAtTime(300,n);o.frequency.exponentialRampToValueAtTime(1200,n+0.4);g.gain.setValueAtTime(0,n);g.gain.linearRampToValueAtTime(bv,n+0.1);g.gain.exponentialRampToValueAtTime(0.001,n+0.4);o.start(n);o.stop(n+0.4);const o2=ac.createOscillator();const g2=ac.createGain();o2.connect(g2);g2.connect(ac.destination);o2.type='triangle';o2.frequency.setValueAtTime(1500,n+0.15);g2.gain.setValueAtTime(bv*0.6,n+0.15);g2.gain.exponentialRampToValueAtTime(0.001,n+0.15+0.2);o2.start(n+0.15);o2.stop(n+0.15+0.2)}
    function playLevelUpSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.18;const f=[392.00,493.88,587.33,783.99];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='triangle';o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv,n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+0.15);o.start(n+dl);o.stop(n+dl+0.15);dl+=0.1}}
    function playShopPurchaseSound(){const ac=getAudioContext();if(!ac)return;const n=ac.currentTime;const bv=0.13;const f=[1046.50,1318.51];let dl=0;for(let i=0;i<f.length;i++){const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type='square';o.frequency.setValueAtTime(f[i],n+dl);g.gain.setValueAtTime(bv*(1-i*0.3),n+dl);g.gain.exponentialRampToValueAtTime(0.001,n+dl+0.12);o.start(n+dl);o.stop(n+dl+0.12);dl+=0.08}}
    function playGenericClickSound(){playSound(800,50,'triangle',0.05)}

    /* ========== 2桁計算問題生成（変更なし） ========== */
    function generateMathProblem() { /* ... (変更なし) ... */ 
        const a=Math.floor(Math.random()*90)+10;const b=Math.floor(Math.random()*90)+10;let op,q,ans;if(Math.random()<0.6){op='+';q=`${a} + ${b}`;ans=a+b}else{const l=Math.max(a,b);const s=Math.min(a,b);op='-';q=`${l} - ${s}`;ans=l-s}return{question:q+' = ?',answer:ans,operation:op}
    }

    /* ========== 問題表示 (テンキー対応) ========== */
    function showMathProblem() {
      playGenericClickSound();
      currentProblem = generateMathProblem();
      mathQuestion.textContent = currentProblem.question;
      
      numpadInput = ""; // テンキー入力をリセット
      mathAnswerDisplay.textContent = "_"; // 表示をリセット (プレースホルダ)
      mathAnswerDisplay.classList.remove('correct', 'incorrect'); // スタイルリセット
      
      mathFeedback.textContent = '';
      mathModal.classList.remove('hidden');
      // mathAnswer.focus(); // 標準入力は使わないので不要
    }

    /* ========== 答え確認 (テンキー対応) ========== */
    function checkAnswer() {
      if (numpadInput === "") return; // 何も入力されていなければ何もしない

      const userAnswer = parseInt(numpadInput);
      const isCorrect = userAnswer === currentProblem.answer;
      
      gameState.totalProblems++;
      
      if (isCorrect) {
        gameState.correctProblems++;
        gameState.consecutiveCorrect++;
        
        let basePoints = 50; 
        const bonusPoints = Math.min(gameState.consecutiveCorrect * 10, 100);
        const totalPoints = basePoints + bonusPoints;
        
        gameState.studyPoints += totalPoints;
        addMathExp(totalPoints);
        
        mathFeedback.textContent = `🎉 正解！ +${totalPoints}ポイント`;
        mathFeedback.style.color = '#4ecdc4';
        mathAnswerDisplay.classList.add('correct');
        mathAnswerDisplay.classList.remove('incorrect');
        playSuccessSound();
        
        if (Math.random() < 0.7) {
          setTimeout(() => {
            summonMonster();
            mathModal.classList.add('hidden');
          }, 1200);
        } else {
          setTimeout(() => {
            mathModal.classList.add('hidden');
          }, 1200);
        }
        
      } else {
        gameState.consecutiveCorrect = 0;
        mathFeedback.textContent = `❌ 不正解... 答えは ${currentProblem.answer} です`;
        mathFeedback.style.color = '#ff6b6b';
        mathAnswerDisplay.classList.add('incorrect');
        mathAnswerDisplay.classList.remove('correct');
        playErrorSound(); 
        
        // 不正解でもモーダルを閉じないように変更する場合は以下のsetTimeoutをコメントアウトまたは削除
        setTimeout(() => {
           mathModal.classList.add('hidden');
        }, 1800); 
      }
      
      updateDisplay();
      calculateGridBonuses();
      // numpadInput = ""; // 次の問題のためにリセット (showMathProblemでもリセットされる)
      // mathAnswerDisplay.textContent = "_";
    }
    
    /* ========== テンキー処理 ========== */
    mathNumpad.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        playGenericClickSound();

        const value = e.target.dataset.value;

        if (value === 'C') { // Clear
            numpadInput = "";
        } else if (value === 'BS') { // Backspace
            numpadInput = numpadInput.slice(0, -1);
        } else if (numpadInput.length < 5) { // 数字ボタン (最大5桁までなど)
            numpadInput += value;
        }
        mathAnswerDisplay.textContent = numpadInput || "_"; // 空ならプレースホルダ
        mathAnswerDisplay.classList.remove('correct', 'incorrect'); // 入力中はスタイルリセット
    });


    /* ========== モンスター召喚 (変更なし) ========== */
    function summonMonster(forceRare=false){const maxCells=gameState.gridSize*gameState.gridSize;const emptyCells=[];for(let i=0;i<maxCells;i++){if(!gameState.grid[i])emptyCells.push(i)}if(emptyCells.length===0){showReward('❌ グリッドが満杯です！');return}playSummonMonsterSound();let monsterId;if(forceRare||gameState.shopItems.rareTicket.count>0){if(gameState.shopItems.rareTicket.count>0){gameState.shopItems.rareTicket.count--}const rareMonsters=[4,5,6,7,8];monsterId=rareMonsters[Math.floor(Math.random()*rareMonsters.length)]}else{const rand=Math.random();if(rand<0.5)monsterId=1;else if(rand<0.75)monsterId=2;else if(rand<0.9)monsterId=3;else monsterId=4}const randomCell=emptyCells[Math.floor(Math.random()*emptyCells.length)];gameState.grid[randomCell]=monsterId;if(!gameState.discoveredMonsters.has(monsterId)){gameState.discoveredMonsters.add(monsterId);updatePokedex();showLevelUp(`🎉 新モンスター発見！ ${monsters[monsterId].emoji} ${monsters[monsterId].name}`);playLevelUpSound()}showReward(`✨ ${monsters[monsterId].emoji} ${monsters[monsterId].name} を召喚！`);renderGrid();if(gameState.shopItems.autoMerge.bought){setTimeout(checkAutoMerge,500)}}

    /* ========== 経験値システム (変更なし) ========== */
    function addMathExp(points){gameState.mathExp+=points;let leveledUp=false;while(gameState.mathExp>=gameState.expToNext){gameState.mathExp-=gameState.expToNext;gameState.mathLevel++;gameState.expToNext=Math.floor(gameState.expToNext*1.3);showLevelUp(`🎓 数学レベル${gameState.mathLevel}達成！`);leveledUp=true}if(leveledUp){playLevelUpSound()}}

    /* ========== グリッド拡張 (変更なし) ========== */
    function expandGrid(){if(gameState.gridSize>=5)return;gameState.gridSize=5;const newGrid=Array(25).fill(null);for(let i=0;i<16;i++){if(gameState.grid[i]){newGrid[i]=gameState.grid[i]}}gameState.grid=newGrid;gridEl.style.gridTemplateColumns='repeat(5, 1fr)';for(let i=16;i<25;i++){const cell=document.createElement('div');cell.className='cell';cell.dataset.index=i;cell.addEventListener('click',()=>handleCellClick(i));cell.addEventListener('dragover',handleDragOver);cell.addEventListener('drop',(e)=>handleDrop(e,i));gridEl.appendChild(cell)}renderGrid();showLevelUp('🔧 グリッドが5×5に拡張されました！');playLevelUpSound()}

    /* ========== グリッドボーナス計算 (変更なし) ========== */
    function calculateGridBonuses(){document.querySelectorAll('.cell').forEach(c=>c.classList.remove('bonus'));const cells=document.querySelectorAll('.cell');cells.forEach(c=>{if(c&&c.classList){c.classList.remove('bonus')}});const maxCells=gameState.gridSize*gameState.gridSize;let bonusMultiplier=1.0;for(let r=0;r<gameState.gridSize;r++){const rowMonsters=[];for(let col=0;col<gameState.gridSize;col++){const i=r*gameState.gridSize+col;if(gameState.grid[i]){rowMonsters.push(gameState.grid[i])}}const monsterCounts={};rowMonsters.forEach(id=>{monsterCounts[id]=(monsterCounts[id]||0)+1});for(const[mId,cnt]of Object.entries(monsterCounts)){if(cnt>=3){bonusMultiplier+=0.5;for(let col=0;col<gameState.gridSize;col++){const i=r*gameState.gridSize+col;if(gameState.grid[i]==mId&&gridEl.children[i]){gridEl.children[i].classList.add('bonus')}}}}}const corners=[0,gameState.gridSize-1,maxCells-gameState.gridSize,maxCells-1];let cornerRareCount=0;corners.forEach(i=>{if(gameState.grid[i]&&monsters[gameState.grid[i]].rarity>=5){cornerRareCount++;if(gridEl.children[i])gridEl.children[i].classList.add('bonus')}});if(cornerRareCount>=2){bonusMultiplier+=0.3}return bonusMultiplier}

    /* ========== 自動合成 (変更なし) ========== */
    function checkAutoMerge(){if(!gameState.shopItems.autoMerge.bought)return;const maxCells=gameState.gridSize*gameState.gridSize;for(let i=0;i<maxCells-1;i++){for(let j=i+1;j<maxCells;j++){const m1=gameState.grid[i];const m2=gameState.grid[j];if(m1&&m2&&m1===m2&&m1<15){mergeMonsters(i,j);return}}}}

    /* ========== ショップシステム (変更なし) ========== */
    function initShop(){shopItemsEl.innerHTML='';shopItemsData.forEach(item=>{const itemEl=document.createElement('div');itemEl.className='shop-item';const owned=gameState.shopItems[item.id];const canBuy=gameState.studyPoints>=item.price&&(owned.count<item.maxCount||!owned.bought);itemEl.innerHTML=`<div class="shop-item-info"><div class="shop-item-name">${item.name}</div><div class="shop-item-desc">${item.desc}</div>${item.maxCount>1?`<div class="shop-item-desc">所持: ${owned.count||0}</div>`:''}</div><div style="display:flex;align-items:center;"><div class="shop-item-price">⭐${item.price}</div><button class="btn ${canBuy?'btn-primary':'btn-secondary'}" ${canBuy?'':'disabled'} onclick="buyItem('${item.id}')">${canBuy?'購入':(owned.bought?'購入済':'不足')}</button></div>`;shopItemsEl.appendChild(itemEl)})}
    function buyItem(itemId){const item=shopItemsData.find(i=>i.id===itemId);const owned=gameState.shopItems[itemId];if(gameState.studyPoints>=item.price&&(owned.count<item.maxCount||!owned.bought)){gameState.studyPoints-=item.price;if(item.maxCount===1){owned.bought=true}else{owned.count=(owned.count||0)+1}item.effect();initShop();updateDisplay();showReward(`🛒 ${item.name} を購入しました！`);playShopPurchaseSound()}else{playErrorSound()}}

    /* ========== ショップアイテム効果 (変更なし) ========== */
    function activateExpBooster(){showLevelUp('⚡ 30分間経験値+50%！');gameState.expBoosterRemaining=10;playLevelUpSound()}
    function useRareTicket(){showLevelUp('🎫 レアガチャ券を獲得！');playShopPurchaseSound()}
    function activateAutoMerge(){showLevelUp('🤖 自動合成機能が有効になりました！');playLevelUpSound()}

    /* ========== 表示更新 (変更なし) ========== */
    function updateDisplay(){mathLevelEl.textContent=gameState.mathLevel;studyPointsEl.textContent=gameState.studyPoints.toLocaleString();shopPointsEl.textContent=gameState.studyPoints.toLocaleString();streakEl.textContent=gameState.consecutiveCorrect;const acc=gameState.totalProblems>0?Math.round((gameState.correctProblems/gameState.totalProblems)*100):100;accuracyEl.textContent=acc;discoveredCountEl.textContent=gameState.discoveredMonsters.size}

    /* ========== グリッド描画 (変更なし) ========== */
    function renderGrid(){const maxCells=gameState.gridSize*gameState.gridSize;const cells=gridEl.children;for(let i=0;i<maxCells;i++){if(i<cells.length){const cell=cells[i];const mId=gameState.grid[i];if(mId){const m=monsters[mId];cell.innerHTML=`<div class="monster">${m.emoji}</div>`;cell.className='cell occupied';cell.draggable=true}else{cell.innerHTML='';cell.className='cell';cell.draggable=false}}}}

    /* ========== ドラッグ&ドロップ (変更なし) ========== */
    let draggedIndex=null;function handleDragStart(e,index){draggedIndex=index;e.target.closest('.cell').classList.add('dragging');playGenericClickSound()}
    function handleDragOver(e){e.preventDefault();const cell=e.target.closest('.cell');if(cell&&!cell.classList.contains('drop-target')){document.querySelectorAll('.cell.drop-target').forEach(c=>c.classList.remove('drop-target'));cell.classList.add('drop-target')}}
    function handleDragLeave(e){const cell=e.target.closest('.cell');if(cell){cell.classList.remove('drop-target')}}
    function handleDrop(e,targetIndex){e.preventDefault();document.querySelectorAll('.cell').forEach(c=>c.classList.remove('drop-target','dragging'));if(draggedIndex===null||draggedIndex===targetIndex)return;const dId=gameState.grid[draggedIndex];const tId=gameState.grid[targetIndex];if(dId&&tId&&dId===tId){mergeMonsters(draggedIndex,targetIndex)}else if(!tId){gameState.grid[targetIndex]=dId;gameState.grid[draggedIndex]=null;playSound(300,80,'triangle',0.08);renderGrid();calculateGridBonuses()}draggedIndex=null}

    /* ========== モンスター合成 (変更なし) ========== */
    function mergeMonsters(idx1,idx2){const mId=gameState.grid[idx1];const nId=mId+1;if(nId<=15){gameState.grid[idx2]=nId;gameState.grid[idx1]=null;if(!gameState.discoveredMonsters.has(nId)){gameState.discoveredMonsters.add(nId);updatePokedex();showLevelUp(`🎉 新モンスター誕生！ ${monsters[nId].emoji} ${monsters[nId].name}`);playLevelUpSound()}showMergeEffect(idx2);const expGain=monsters[nId].power;addMathExp(Math.floor(expGain/10));gameState.studyPoints+=Math.floor(expGain/20);playMergeSound();renderGrid();updateDisplay();calculateGridBonuses()}}

    /* ========== 図鑑システム (変更なし) ========== */
    function initPokedex(){for(let i=1;i<=15;i++){const card=document.createElement('div');card.className='monster-card';card.innerHTML=`<div class="monster-emoji">${gameState.discoveredMonsters.has(i)?monsters[i].emoji:'❓'}</div><div class="monster-name">${gameState.discoveredMonsters.has(i)?monsters[i].name:'???'}</div>`;if(gameState.discoveredMonsters.has(i)){card.classList.add('discovered')}monsterListEl.appendChild(card)}}
    function updatePokedex(){const cards=monsterListEl.children;for(let i=1;i<=15;i++){const card=cards[i-1];if(gameState.discoveredMonsters.has(i)){card.innerHTML=`<div class="monster-emoji">${monsters[i].emoji}</div><div class="monster-name">${monsters[i].name}</div>`;card.classList.add('discovered')}}}

    /* ========== 自動学習システム (変更なし) ========== */
    function toggleAutoStudy(){playGenericClickSound();gameState.autoStudy=!gameState.autoStudy;autoBtn.textContent=gameState.autoStudy?'🤖 自動学習 ON':'🤖 自動学習 OFF';autoBtn.style.background=gameState.autoStudy?'linear-gradient(45deg,#4ecdc4,#44a08d)':'linear-gradient(45deg,#a8e6cf,#88d8c0)'}
    function startAutoStudy(){setInterval(()=>{if(!gameState.autoStudy)return;gameState.totalProblems++;if(Math.random()<0.8){gameState.correctProblems++;gameState.consecutiveCorrect++;const pts=25;gameState.studyPoints+=pts;addMathExp(pts);if(Math.random()<0.3){summonMonster()}showReward(`🤖 自動学習: +${pts}P`);playSound(600,80,'sine',0.05)}else{gameState.consecutiveCorrect=0;playSound(150,100,'square',0.05)}updateDisplay();calculateGridBonuses()},8000)}

    /* ========== エフェクト関数 (変更なし) ========== */
    function showMergeEffect(cellIndex){if(!gridEl.children[cellIndex])return;const cell=gridEl.children[cellIndex];const rect=cell.getBoundingClientRect();const effect=document.createElement('div');effect.className='merge-effect';effect.textContent='✨💫⭐';effect.style.left=rect.left+rect.width/2+'px';effect.style.top=rect.top+rect.height/2+'px';effect.style.transform='translate(-50%,-50%)';effectsContainer.appendChild(effect);setTimeout(()=>effect.remove(),800)}
    function showLevelUp(message){const pos=getNextEffectPosition();const popup=document.createElement('div');popup.className='level-up';popup.textContent=message;popup.style.top=pos.top;popup.style.left=pos.left;popup.style.transform='translate(-50%,-50%)';effectsContainer.appendChild(popup);setTimeout(()=>popup.remove(),2500)}
    function showReward(message){const popup=document.createElement('div');popup.className='reward-popup';popup.textContent=message;popup.style.top='20px';popup.style.right='20px';effectsContainer.appendChild(popup);setTimeout(()=>popup.remove(),2500)}

    /* ========== 初期化 ========== */
    function initGame() {
      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.addEventListener('click', () => handleCellClick(i));
        cell.addEventListener('dragstart', (e) => handleDragStart(e, i));
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragleave', handleDragLeave); 
        cell.addEventListener('drop', (e) => handleDrop(e, i));
        gridEl.appendChild(cell);
      }

      const gameTitle = document.getElementById('gameTitle');
      let clickCount = 0;
      let clickTimer = null;
      gameTitle.addEventListener('click', () => { /* ... (変更なし、リセット機能) ... */ 
        playGenericClickSound();clickCount++;if(clickCount===1){showReward('🔄 もう一度クリックでリセット');clickTimer=setTimeout(()=>{clickCount=0},3000)}else if(clickCount===2){clearTimeout(clickTimer);clickCount=0;if(confirm('🎓 JUKEN MONSTERをリセットしますか？\n\n⚠️ 以下のデータが失われます：\n・学習レベルと経験値\n・収集したモンスター\n・学習ポイント\n・ショップ購入アイテム\n\n本当にリセットしますか？')){resetGame()}}
      });

      gameState.grid[0] = 1;
      
      studyBtn.addEventListener('click', showMathProblem);
      shopBtn.addEventListener('click', () => { playGenericClickSound(); initShop(); shopModal.classList.remove('hidden'); });
      autoBtn.addEventListener('click', toggleAutoStudy);
      submitBtn.addEventListener('click', checkAnswer); // テンキー入力後、このボタンで回答
      skipBtn.addEventListener('click', () => { /* ... (変更なし、スキップ機能) ... */ 
        playGenericClickSound();if(gameState.shopItems.skipTicket.count>0){gameState.shopItems.skipTicket.count--;showReward('⏭️ スキップ券を使用しました');playShopPurchaseSound()}else{playErrorSound()}mathModal.classList.add('hidden')
      });
      closeShopBtn.addEventListener('click', () => { playGenericClickSound(); shopModal.classList.add('hidden'); });
      
      // mathAnswer.addEventListener('keypress', ...); // 標準入力は使わないのでコメントアウトまたは削除

      initPokedex();
      updateDisplay();
      renderGrid(); 
      calculateGridBonuses();
      startAutoStudy();
    }

    /* ========== リセット機能 (変更なし) ========== */
    function resetGame(){localStorage.removeItem('jukenMonster');showLevelUp('🔄 ゲームをリセットしました！\n新しい冒険が始まります！');playLevelUpSound();setTimeout(()=>location.reload(),2000)}

    /* ========== セルクリック処理 (変更なし) ========== */
    function handleCellClick(idx){if(!gameState.grid[idx])return;const mId=gameState.grid[idx];const m=monsters[mId];showReward(`${m.emoji} ${m.name} (⚡${m.power})`);playSound(400+m.rarity*50,80,'sine',0.07)}

    /* ========== 自動保存システム (変更なし) ========== */
    function saveGame(){localStorage.setItem('jukenMonster',JSON.stringify({...gameState,discoveredMonsters:Array.from(gameState.discoveredMonsters)}))}
    function loadGame(){const saved=localStorage.getItem('jukenMonster');if(saved){const data=JSON.parse(saved);gameState={...gameState,...data,discoveredMonsters:new Set(data.discoveredMonsters||[1])};if(gameState.gridSize===5&&gridEl.children.length<25){gridEl.style.gridTemplateColumns='repeat(5,1fr)';for(let i=gridEl.children.length;i<25;i++){const cell=document.createElement('div');cell.className='cell';cell.dataset.index=i;gridEl.appendChild(cell)}}}}

    /* ========== タッチデバイス対応 (変更なし) ========== */
    let touchStartX,touchStartY,touchEndX,touchEndY;let isTouchDragging=false;let touchDraggedIndex=null;
    gridEl.addEventListener('touchstart',(e)=>{const t=e.touches[0];touchStartX=t.clientX;touchStartY=t.clientY;const c=e.target.closest('.cell');if(c&&c.dataset.index){touchDraggedIndex=parseInt(c.dataset.index);if(gameState.grid[touchDraggedIndex]){isTouchDragging=true;c.classList.add('dragging');e.preventDefault();playGenericClickSound()}}},{passive:false});
    gridEl.addEventListener('touchmove',(e)=>{if(isTouchDragging){e.preventDefault();const t=e.touches[0];touchEndX=t.clientX;touchEndY=t.clientY;const elB=document.elementFromPoint(touchEndX,touchEndY);const tC=elB?.closest('.cell');document.querySelectorAll('.cell.drop-target').forEach(c=>c.classList.remove('drop-target'));if(tC&&tC.dataset.index!==touchDraggedIndex?.toString()){tC.classList.add('drop-target')}}},{passive:false});
    gridEl.addEventListener('touchend',(e)=>{if(isTouchDragging){const elB=document.elementFromPoint(touchEndX,touchEndY);const tC=elB?.closest('.cell');if(tC&&tC.dataset.index){const tIdx=parseInt(tC.dataset.index);if(tIdx!==touchDraggedIndex){const dId=gameState.grid[touchDraggedIndex];const tgId=gameState.grid[tIdx];if(dId&&tgId&&dId===tgId){mergeMonsters(touchDraggedIndex,tIdx)}else if(!tgId&&dId){gameState.grid[tIdx]=dId;gameState.grid[touchDraggedIndex]=null;playSound(300,80,'triangle',0.08);renderGrid();calculateGridBonuses()}}}document.querySelectorAll('.cell').forEach(c=>c.classList.remove('drop-target','dragging'));isTouchDragging=false;touchDraggedIndex=null}});

    /* ========== チュートリアル (変更なし) ========== */
    function showTutorial(){const msgs=['🎓 JUKEN MONSTERへようこそ！','📚 2桁の計算問題を解いてモンスターを召喚しよう！','🧮 正解すればするほど学習ポイントが貯まる！','✨ 同じモンスター同士をくっつけて進化させよう！','🏪 ショップで便利アイテムを購入できる！','🏆 全15種類のモンスター図鑑完成を目指そう！'];let idx=0;function showNext(){if(idx<msgs.length){showLevelUp(msgs[idx]);if(idx>0)playSound(600+idx*50,150,'sine',0.08);idx++;setTimeout(showNext,3000)}}showNext()}

    /* ========== ゲーム開始 ========== */
    window.addEventListener('load', () => {
      loadGame();
      initGame(); 
      setInterval(saveGame, 10000);
      if (!localStorage.getItem('jukenMonster')) {
        setTimeout(showTutorial, 1000);
      }
    });
  </script>
</body>
</html>